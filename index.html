<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Professional Car Racing</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .container {
            max-width: 100%;
            width: 100%;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        /* Screen Management */
        .screen {
            background: #2a2a2a;
            border-radius: 12px;
            border: 1px solid #404040;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 900px;
            min-height: 80vh;
            padding: 30px;
            position: relative;
            overflow-y: auto;
            max-height: 95vh;
        }

        .hidden {
            display: none !important;
        }

        /* Typography */
        .title {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #a0a0a0;
            font-size: 1.1rem;
        }

        /* Buttons */
        .btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 8px;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 50px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .btn:hover {
            background: #357abd;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary { background: #4a90e2; }
        .btn-secondary { background: #6c757d; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3); }
        .btn-secondary:hover { background: #545b62; }
        
        .btn-success { background: #28a745; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3); }
        .btn-success:hover { background: #218838; }
        
        .btn-warning { background: #ffc107; color: #000; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3); }
        .btn-warning:hover { background: #e0a800; }
        
        .btn-danger { background: #dc3545; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3); }
        .btn-danger:hover { background: #c82333; }

        .btn-small {
            padding: 10px 15px;
            font-size: 14px;
            min-height: 40px;
        }

        /* Cards and Panels */
        .card {
            background: #333333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #404040;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: #333333;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #404040;
        }

        .stat-label {
            display: block;
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            color: #4a90e2;
        }

        /* Menu Layout */
        .menu-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        /* Game Screen */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #333333;
            border-radius: 8px;
            border: 1px solid #404040;
        }

        .game-title h2 {
            margin: 0;
            font-size: 1.2rem;
            color: #ffffff;
        }

        .current-track {
            font-size: 0.8rem;
            color: #a0a0a0;
            margin-top: 2px;
        }

        .game-actions {
            display: flex;
            gap: 10px;
        }

        .game-hud {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #333333;
            border-radius: 8px;
            border: 1px solid #404040;
        }

        .hud-item {
            text-align: center;
            padding: 8px;
            background: #404040;
            border-radius: 6px;
        }

        .hud-label {
            font-size: 0.7rem;
            color: #a0a0a0;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hud-value {
            font-size: 1rem;
            font-weight: bold;
            color: #4a90e2;
        }

        .hud-item.warning .hud-value { color: #ffc107; }
        .hud-item.danger .hud-value { color: #dc3545; }
        .hud-item.active {
            background: #4a90e2;
            animation: pulse 1s ease infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        /* Game Area */
        .game-area {
            position: relative;
            width: 100%;
            height: 90vh;
            
            background: #87ceeb;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #404040;
            margin-bottom: 20px;
        }

        .road-container {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: min(300px, 70%);
            height: 100%;
            z-index: 1;
        }

        .road {
            width: 100%;
            height: 100%;
            background: #444444;
            position: relative;
            border-left: 4px solid #ffffff;
            border-right: 4px solid #ffffff;
            overflow: hidden;
        }

        .road-line {
            position: absolute;
            left: 25%;
            width: 3px;
            height: 30px;
            background: #ffffff;
            animation: roadMove 1s linear infinite;
            border-radius: 2px;
        }

        .road-line:nth-child(even) {
            left: 75%;
        }

        @keyframes roadMove {
            from {
                top: -30px;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            to {
                top: 100%;
                opacity: 0;
            }
        }

        /* Track Themes */
        .game-area.night {
            background: #1a1a2e;
        }

        .road.night {
            background: #16213e;
            border-color: #0f3460;
        }

        .road.night .road-line {
            background: #ffffff;
        }

        .game-area.desert {
            background: #daa520;
        }

        .road.desert {
            background: #8b4513;
            border-color: #ff6347;
        }

        .road.desert .road-line {
            background: #ffffff;
        }

        .game-area.snow {
            background: #e6f3ff;
        }

        .road.snow {
            background: #708090;
            border-color: #4682b4;
        }

        .road.snow .road-line {
            background: #ffffff;
        }

        /* Player Car */
        .player-car {
            position: absolute;
            width: 40px;
            height: 60px;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            transition: left 0.2s ease;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
        }

        .player-car.jumping {
            animation: carJump 0.8s ease;
            z-index: 15;
        }

        @keyframes carJump {
            0% {
                transform: translateX(-50%) translateY(0) scale(1);
                filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
            }
            25% {
                transform: translateX(-50%) translateY(-20px) scale(1.05);
                filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3));
            }
            50% {
                transform: translateX(-50%) translateY(-40px) scale(1.1);
                filter: drop-shadow(0 12px 24px rgba(0, 0, 0, 0.2));
            }
            75% {
                transform: translateX(-50%) translateY(-20px) scale(1.05);
                filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3));
            }
            100% {
                transform: translateX(-50%) translateY(0) scale(1);
                filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
            }
        }

        .player-car.shielded {
            animation: shieldEffect 0.5s ease infinite alternate;
        }

        @keyframes shieldEffect {
            0% {
                filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4)) drop-shadow(0 0 10px rgba(0, 255, 255, 0.5));
            }
            100% {
                filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4)) drop-shadow(0 0 20px rgba(0, 255, 255, 0.8));
            }
        }

        /* Game Objects */
        .obstacle {
            position: absolute;
            width: 35px;
            height: 55px;
            z-index: 5;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .powerup {
            position: absolute;
            width: 30px;
            height: 30px;
            z-index: 6;
            border-radius: 50%;
            animation: powerupFloat 1s ease infinite alternate;
        }

        @keyframes powerupFloat {
            0% {
                transform: translateX(-50%) scale(1) rotate(0deg);
                opacity: 0.9;
                box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
            }
            50% {
                transform: translateX(-50%) scale(1.15) rotate(180deg);
                opacity: 1;
                box-shadow: 0 0 20px rgba(74, 144, 226, 0.6);
            }
            100% {
                transform: translateX(-50%) scale(1) rotate(360deg);
                opacity: 0.9;
                box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
            }
        }

        /* Track Selection */
        .track-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .track-option {
            background: #333333;
            border: 2px solid #404040;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .track-option:hover {
            border-color: #4a90e2;
            transform: translateY(-2px);
        }

        .track-option.selected {
            border-color: #4a90e2;
            background: #404040;
        }

        .track-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .track-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .track-desc {
            font-size: 0.8rem;
            color: #a0a0a0;
        }

        /* Car Selection */
        .car-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .car-card {
            background: #333333;
            border: 2px solid #404040;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .car-card:hover {
            transform: translateY(-3px);
            border-color: #4a90e2;
            box-shadow: 0 8px 24px rgba(74, 144, 226, 0.2);
        }

        .car-preview-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            height: 80px;
            align-items: center;
        }

        .car-preview {
            width: 60px;
            height: 80px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .car-info h4 {
            margin-bottom: 8px;
            color: #ffffff;
            font-size: 1.1rem;
            text-align: center;
        }

        .car-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.8rem;
            color: #a0a0a0;
        }

        .car-stat {
            background: #404040;
            padding: 5px 8px;
            border-radius: 4px;
            text-align: center;
        }

        /* Garage */
        .garage-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
        }

        /* Car Creator */
        .creator-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .car-preview-section {
            background: #333333;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            height: fit-content;
            border: 1px solid #404040;
        }

        .car-preview-section h3 {
            margin-bottom: 20px;
            color: #ffffff;
        }

        .car-preview-display {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            margin-bottom: 15px;
        }

        .car-preview-large {
            width: 80px;
            height: 120px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .car-customization {
            background: #333333;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #404040;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #ffffff;
            font-size: 1rem;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #404040;
            border-radius: 6px;
            background: #404040;
            color: white;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #4a90e2;
            background: #4a4a4a;
        }

        .car-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }

        .car-type-option {
            background: #404040;
            border: 2px solid #505050;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .car-type-option:hover {
            border-color: #4a90e2;
        }

        .car-type-option.selected {
            border-color: #4a90e2;
            background: #4a4a4a;
        }

        .car-type-preview {
            width: 50px;
            height: 70px;
            margin-bottom: 10px;
        }

        .car-type-name {
            font-size: 0.9rem;
            color: #ffffff;
            font-weight: 600;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 12px;
            max-width: 400px;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border: 3px solid #505050;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #4a90e2;
            border-width: 4px;
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
        }

        /* Performance Slider */
        .slider-container {
            margin-top: 15px;
        }

        .performance-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #404040;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .performance-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4a90e2;
            cursor: pointer;
        }

        .performance-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4a90e2;
            cursor: pointer;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #a0a0a0;
        }

        /* Achievements */
        .achievements-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .achievement {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin-bottom: 15px;
            background: #333333;
            border-radius: 8px;
            border: 2px solid #404040;
            transition: all 0.2s ease;
        }

        .achievement.unlocked {
            background: #2d4a2d;
            border-color: #28a745;
        }

        .achievement .icon {
            font-size: 2rem;
            min-width: 50px;
            text-align: center;
        }

        .achievement .info h4 {
            color: #ffffff;
            margin-bottom: 5px;
        }

        .achievement .info p {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin: 0;
        }

        /* Mobile Controls */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            background: rgba(42, 42, 42, 0.95);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid #404040;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mobile-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #404040;
            border: 2px solid #505050;
            color: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .mobile-btn:active {
            background: #4a90e2;
            transform: scale(0.9);
        }

        .mobile-btn.disabled {
            background: #2a2a2a;
            border-color: #333333;
            color: #666666;
        }

        .direction-btn {
            background: #404040;
            border-color: #4a90e2;
        }

        .action-btn {
            background: #404040;
            border-color: #28a745;
        }

        /* Game Modals */
        .game-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-content {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            border: 1px solid #404040;
            min-width: 300px;
            max-width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.5rem;
        }

        .final-stats {
            margin: 20px 0;
        }

        .final-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #333333;
            border-radius: 8px;
        }

        .final-score .label {
            color: #a0a0a0;
        }

        .final-score .value {
            color: #4a90e2;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .new-high-score {
            background: #28a745;
            color: #ffffff;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            margin: 10px 0;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Particles */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #4a90e2;
            border-radius: 50%;
            pointer-events: none;
            z-index: 15;
            animation: particleFade 1s ease-out forwards;
        }

        @keyframes particleFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
            }
        }

        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 12;
        }

        /* Tutorial */
        .tutorial-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .tutorial-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #333333;
            border-radius: 8px;
            border: 1px solid #404040;
        }

        .tutorial-section h3 {
            margin-bottom: 15px;
            color: #4a90e2;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .control-item {
            text-align: center;
            padding: 15px;
            background: #404040;
            border-radius: 6px;
        }

        .control-key {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #4a90e2;
        }

        .control-desc {
            font-size: 0.9rem;
            color: #a0a0a0;
        }

        .powerups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .powerup-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #404040;
            border-radius: 6px;
        }

        .powerup-icon {
            font-size: 2rem;
            min-width: 50px;
            text-align: center;
        }

        .powerup-item strong {
            color: #ffffff;
            display: block;
            margin-bottom: 5px;
        }

        .powerup-item p {
            font-size: 0.8rem;
            color: #a0a0a0;
            margin: 0;
        }

        /* Footer */
        .screen-footer {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #404040;
        }

        .desktop-controls {
            text-align: center;
            margin-top: 15px;
        }

        .controls-hint {
            color: #a0a0a0;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .screen {
                padding: 10px;
                min-height: 95vh;
                max-height: 100vh;
                overflow-y: auto;
            }

            .title {
                font-size: 1.8rem;
            }

            .creator-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .menu-buttons {
                grid-template-columns: 1fr;
            }

            .stats-panel {
                grid-template-columns: 1fr;
            }

            .game-header {
                flex-direction: column;
                gap: 8px;
                text-align: center;
                padding: 8px 12px;
            }

            .game-title h2 {
                font-size: 1rem;
            }

            .current-track {
                font-size: 0.7rem;
            }

            .game-hud {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                padding: 8px;
                margin-bottom: 15px;
            }

            .hud-item {
                padding: 6px;
            }

            .hud-label {
                font-size: 0.6rem;
            }

            .hud-value {
                font-size: 0.9rem;
            }

            .game-area {
                height: 45vh;
                min-height: 250px;
                max-height: 350px;
                margin-bottom: 15px;
            }

            .road-container {
                width: min(220px, 75%);
            }

            .mobile-controls {
                display: block;
            }

            .desktop-controls {
                display: none;
            }

            .modal-actions {
                flex-direction: column;
            }

            .player-car {
                width: 28px;
                height: 42px;
            }

            .obstacle {
                width: 26px;
                height: 39px;
            }

            .powerup {
                width: 22px;
                height: 22px;
            }

            .mobile-btn {
                width: 45px;
                height: 45px;
                font-size: 14px;
            }

            .control-row {
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            .screen {
                padding: 8px;
            }

            .title {
                font-size: 1.6rem;
            }

            .game-area {
                height: 40vh;
                min-height: 200px;
                max-height: 280px;
            }

            .road-container {
                width: min(180px, 80%);
            }

            .player-car {
                width: 24px;
                height: 36px;
            }

            .obstacle {
                width: 22px;
                height: 33px;
            }

            .powerup {
                width: 18px;
                height: 18px;
            }

            .mobile-btn {
                width: 40px;
                height: 40px;
                font-size: 12px;
            }

            .control-row {
                gap: 6px;
            }

            .game-hud {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
                padding: 6px;
                margin-bottom: 10px;
            }

            .hud-item {
                padding: 4px;
            }

            .hud-label {
                font-size: 0.5rem;
            }

            .hud-value {
                font-size: 0.8rem;
            }

            .game-header {
                padding: 6px 8px;
            }

            .game-title h2 {
                font-size: 0.9rem;
            }

            .current-track {
                font-size: 0.6rem;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .screen {
                max-height: 95vh;
                padding: 5px;
            }
            
            .game-area {
                height: 60vh;
                min-height: 200px;
                max-height: 300px;
            }
            
            .mobile-controls {
                bottom: 5px;
            }
            
            .game-hud {
                margin-bottom: 8px;
                padding: 5px;
            }

            .game-header {
                padding: 5px 8px;
                margin-bottom: 8px;
            }
        }

        /* Very small screens */
        @media (max-height: 600px) {
            .screen {
                min-height: 100vh;
                max-height: 100vh;
                padding: 5px;
            }

            .game-area {
                height: 35vh;
                min-height: 180px;
                max-height: 250px;
            }

            .game-hud {
                margin-bottom: 5px;
                padding: 5px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover,
            .car-card:hover,
            .track-option:hover,
            .car-type-option:hover,
            .color-option:hover {
                transform: none;
            }

            .btn:active,
            .car-card:active,
            .track-option:active,
            .car-type-option:active,
            .color-option:active {
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Menu -->
        <div id="menu-screen" class="screen">
            <h1 class="title">üèéÔ∏è Professional Racing</h1>
            <p class="subtitle">Ultimate Car Racing Experience</p>
            
            <div class="stats-panel">
                <div class="stat-item">
                    <span class="stat-label">High Score</span>
                    <span class="stat-value" id="menu-high-score">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Games Played</span>
                    <span class="stat-value" id="menu-games-played">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Distance</span>
                    <span class="stat-value" id="menu-total-distance">0km</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Achievements</span>
                    <span class="stat-value" id="menu-achievements">0/8</span>
                </div>
            </div>
            
            <div class="card">
                <h3>üèÜ Recent Achievements</h3>
                <div id="achievements-preview-list">
                    <p style="color: #a0a0a0; text-align: center;">No achievements unlocked yet</p>
                </div>
            </div>
            
            <div class="menu-buttons">
                <button class="btn btn-primary" onclick="showScreen('select-screen')">
                    üöó Start Racing
                </button>
                <button class="btn btn-secondary" onclick="showScreen('garage-screen')">
                    üè† Garage
                </button>
                <button class="btn btn-success" onclick="showScreen('tutorial-screen')">
                    üìö How to Play
                </button>
                <button class="btn btn-warning" onclick="showScreen('achievements-screen')">
                    üèÜ Achievements
                </button>
            </div>
        </div>

        <!-- Tutorial Screen -->
        <div id="tutorial-screen" class="screen hidden">
            <h2 class="title">üìö How to Play</h2>
            <div class="tutorial-content">
                <div class="tutorial-section">
                    <h3>üéØ Objective</h3>
                    <p>Race through different tracks, avoid obstacles, collect power-ups, and achieve the highest score possible!</p>
                </div>
                
                <div class="tutorial-section">
                    <h3>üïπÔ∏è Controls</h3>
                    <div class="controls-grid">
                        <div class="control-item">
                            <div class="control-key">‚Üê ‚Üí</div>
                            <div class="control-desc">Move Left/Right</div>
                        </div>
                        <div class="control-item">
                            <div class="control-key">‚Üë</div>
                            <div class="control-desc">Speed Up</div>
                        </div>
                        <div class="control-item">
                            <div class="control-key">‚Üì</div>
                            <div class="control-desc">Brake</div>
                        </div>
                        <div class="control-item">
                            <div class="control-key">SPACE</div>
                            <div class="control-desc">Jump</div>
                        </div>
                        <div class="control-item">
                            <div class="control-key">P</div>
                            <div class="control-desc">Pause</div>
                        </div>
                    </div>
                </div>
                
                <div class="tutorial-section">
                    <h3>üíé Power-ups</h3>
                    <div class="powerups-grid">
                        <div class="powerup-item">
                            <div class="powerup-icon">üõ°Ô∏è</div>
                            <div>
                                <strong>Shield</strong>
                                <p>Temporary invincibility against obstacles</p>
                            </div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-icon">‚ö°</div>
                            <div>
                                <strong>Speed Boost</strong>
                                <p>Temporary speed increase</p>
                            </div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-icon">üöÄ</div>
                            <div>
                                <strong>Jump Refill</strong>
                                <p>Adds jump abilities</p>
                            </div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-icon">üí∞</div>
                            <div>
                                <strong>Score Boost</strong>
                                <p>Instant bonus points</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tutorial-section">
                    <h3>üåç Track Types</h3>
                    <div class="powerups-grid">
                        <div class="powerup-item">
                            <div class="powerup-icon">üåÖ</div>
                            <div>
                                <strong>Day Track</strong>
                                <p>Perfect visibility, normal conditions</p>
                            </div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-icon">üåô</div>
                            <div>
                                <strong>Night Track</strong>
                                <p>Reduced visibility, challenging</p>
                            </div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-icon">üèúÔ∏è</div>
                            <div>
                                <strong>Desert Track</strong>
                                <p>High speed, sandstorm effects</p>
                            </div>
                        </div>
                        <div class="powerup-item">
                            <div class="powerup-icon">‚ùÑÔ∏è</div>
                            <div>
                                <strong>Snow Track</strong>
                                <p>Slippery conditions, slower speeds</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="screen-footer">
                <button class="btn btn-secondary" onclick="showScreen('menu-screen')">
                    ‚Üê Back to Menu
                </button>
            </div>
        </div>

        <!-- Achievements Screen -->
        <div id="achievements-screen" class="screen hidden">
            <h2 class="title">üèÜ Achievements</h2>
            <div class="achievements-container">
                <div id="achievements-list">
                    <!-- Achievements will be populated here -->
                </div>
            </div>
            <div class="screen-footer">
                <button class="btn btn-secondary" onclick="showScreen('menu-screen')">
                    ‚Üê Back to Menu
                </button>
            </div>
        </div>

        <!-- Garage Screen -->
        <div id="garage-screen" class="screen hidden">
            <h2 class="title">üè† Your Garage</h2>
            
            <div class="garage-actions">
                <button class="btn btn-primary" onclick="showScreen('create-screen')">
                    üõ†Ô∏è Create New Car
                </button>
                <button class="btn btn-danger" onclick="resetGarage()">
                    üóëÔ∏è Reset Garage
                </button>
            </div>
            
            <div id="garage-car-list" class="car-grid">
                <!-- Cars will be populated here -->
            </div>
            
            <div class="screen-footer">
                <button class="btn btn-secondary" onclick="showScreen('menu-screen')">
                    ‚Üê Back to Menu
                </button>
            </div>
        </div>

        <!-- Car Selection -->
        <div id="select-screen" class="screen hidden">
            <h2 class="title">üöó Select Your Setup</h2>
            
            <div class="card">
                <h3>üåç Choose Track</h3>
                <div class="track-selector">
                    <div class="track-option selected" data-track="day">
                        <div class="track-icon">üåÖ</div>
                        <div class="track-name">Day Track</div>
                        <div class="track-desc">Perfect conditions</div>
                    </div>
                    <div class="track-option" data-track="night">
                        <div class="track-icon">üåô</div>
                        <div class="track-name">Night Track</div>
                        <div class="track-desc">Challenging visibility</div>
                    </div>
                    <div class="track-option" data-track="desert">
                        <div class="track-icon">üèúÔ∏è</div>
                        <div class="track-name">Desert Track</div>
                        <div class="track-desc">High speed racing</div>
                    </div>
                    <div class="track-option" data-track="snow">
                        <div class="track-icon">‚ùÑÔ∏è</div>
                        <div class="track-name">Snow Track</div>
                        <div class="track-desc">Slippery conditions</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üöó Choose Your Car</h3>
                <div id="car-selection-list" class="car-grid">
                    <!-- Cars will be populated here -->
                </div>
            </div>
            
            <div class="screen-footer">
                <button class="btn btn-secondary" onclick="showScreen('menu-screen')">
                    ‚Üê Back to Menu
                </button>
            </div>
        </div>

        <!-- Car Creator -->
        <div id="create-screen" class="screen hidden">
            <h2 class="title">üõ†Ô∏è Create Your Car</h2>
            
            <div class="creator-container">
                <div class="car-preview-section">
                    <h3>Preview</h3>
                    <div class="car-preview-display">
                        <div class="car-preview-large" id="car-preview"></div>
                    </div>
                </div>

                <div class="car-customization">
                    <div class="form-group">
                        <label for="car-name">üè∑Ô∏è Car Name</label>
                        <input type="text" id="car-name" placeholder="Enter your car's name" maxlength="20" />
                    </div>

                    <div class="form-group">
                        <label>üöó Car Type</label>
                        <div class="car-type-grid">
                            <div class="car-type-option selected" data-type="sedan">
                                <div class="car-type-preview" id="sedan-preview"></div>
                                <div class="car-type-name">Sedan</div>
                            </div>
                            <div class="car-type-option" data-type="sports">
                                <div class="car-type-preview" id="sports-preview"></div>
                                <div class="car-type-name">Sports</div>
                            </div>
                            <div class="car-type-option" data-type="suv">
                                <div class="car-type-preview" id="suv-preview"></div>
                                <div class="car-type-name">SUV</div>
                            </div>
                            <div class="car-type-option" data-type="truck">
                                <div class="car-type-preview" id="truck-preview"></div>
                                <div class="car-type-name">Truck</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üé® Car Color</label>
                        <div class="color-palette">
                            <div class="color-option selected" style="background: #ff0000" data-color="#ff0000"></div>
                            <div class="color-option" style="background: #00ff00" data-color="#00ff00"></div>
                            <div class="color-option" style="background: #0000ff" data-color="#0000ff"></div>
                            <div class="color-option" style="background: #ffff00" data-color="#ffff00"></div>
                            <div class="color-option" style="background: #ff00ff" data-color="#ff00ff"></div>
                            <div class="color-option" style="background: #00ffff" data-color="#00ffff"></div>
                            <div class="color-option" style="background: #ffffff" data-color="#ffffff"></div>
                            <div class="color-option" style="background: #000000" data-color="#000000"></div>
                            <div class="color-option" style="background: #FFA500" data-color="#FFA500"></div>
                            <div class="color-option" style="background: #800080" data-color="#800080"></div>
                            <div class="color-option" style="background: #FF69B4" data-color="#FF69B4"></div>
                            <div class="color-option" style="background: #32CD32" data-color="#32CD32"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="speed-slider">‚ö° Performance Level: <span id="speed-value">5</span>/10</label>
                        <div class="slider-container">
                            <input type="range" id="speed-slider" class="performance-slider" min="3" max="10" value="5" step="1" />
                            <div class="slider-labels">
                                <span>Balanced</span>
                                <span>Performance</span>
                                <span>Extreme</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="screen-footer">
                <button class="btn btn-primary" onclick="saveCar()">
                    üíæ Save Car
                </button>
                <button class="btn btn-secondary" onclick="showScreen('garage-screen')">
                    ‚Üê Cancel
                </button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <div class="game-hud">
                <div class="hud-item">
                    <div class="hud-label">Score</div>
                    <div class="hud-value" id="score">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">High Score</div>
                    <div class="hud-value" id="high-score">0</div>
                </div>
                <div class="hud-item" id="jumps-display">
                    <div class="hud-label">Jumps</div>
                    <div class="hud-value" id="jumps">0</div>
                </div>
            </div>

            <div class="game-area" id="game-area">
                <div class="road-container">
                    <div class="road" id="road">
                        <!-- Road lines will be generated here -->
                    </div>
                </div>
                <div class="player-car" id="player-car"></div>
                <div class="particles-container" id="particles"></div>
                
                <!-- Game Over Modal -->
                <div id="game-over-modal" class="game-modal hidden">
                    <div class="modal-content">
                        <h3>üèÅ Race Complete!</h3>
                        <div class="final-stats">
                            <div class="final-score">
                                <span class="label">Final Score:</span>
                                <span class="value" id="final-score">0</span>
                            </div>
                            <div class="final-score">
                                <span class="label">Distance:</span>
                                <span class="value" id="final-distance">0km</span>
                            </div>
                            <div id="new-high-score-badge" class="new-high-score hidden">
                                üéâ New High Score! üéâ
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-primary" onclick="restartGame()">
                                üîÑ Race Again
                            </button>
                            <button class="btn btn-secondary" onclick="showScreen('select-screen')">
                                üè† Back to Menu
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Pause Modal -->
                <div id="pause-modal" class="game-modal hidden">
                    <div class="modal-content">
                        <h3>‚è∏Ô∏è Game Paused</h3>
                        <div class="modal-actions">
                            <button class="btn btn-primary" onclick="resumeGame()">
                                ‚ñ∂Ô∏è Resume
                            </button>
                            <button class="btn btn-secondary" onclick="showScreen('select-screen')">
                                üè† Main Menu
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Controls -->
            <div class="mobile-controls" id="mobile-controls">
                <div class="control-row">
                    <button class="mobile-btn direction-btn" id="left-btn">
                        <span class="btn-icon">‚Üê</span>
                    </button>
                    <button class="mobile-btn action-btn" id="brake-btn">
                        <span class="btn-icon">‚Üì</span>
                    </button>
                    <button class="mobile-btn action-btn" id="jump-btn">
                        <span class="btn-icon">üöÄ</span>
                    </button>
                    <button class="mobile-btn action-btn" id="speed-btn">
                        <span class="btn-icon">‚Üë</span>
                    </button>
                    <button class="mobile-btn direction-btn" id="right-btn">
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </div>

            <div class="desktop-controls">
                <div class="controls-hint">
                    <strong>Controls:</strong> ‚Üê ‚Üí Move ‚Ä¢ ‚Üë Speed Up ‚Ä¢ ‚Üì Brake ‚Ä¢ Space Jump ‚Ä¢ P Pause
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State Management
        class GameState {
            constructor() {
                this.cars = [
                    { id: 1, name: "Lightning Bolt", color: "#ff0000", type: "sports", speed: 6 },
                    { id: 2, name: "Night Rider", color: "#000000", type: "sedan", speed: 5 },
                    { id: 3, name: "Desert Storm", color: "#FFD700", type: "suv", speed: 7 },
                ];
                
                this.currentCar = null;
                this.selectedColor = "#ff0000";
                this.selectedType = "sedan";
                this.selectedSpeed = 5;
                this.selectedTrack = "day";
                
                this.gameRunning = false;
                this.gamePaused = false;
                
                this.player = {
                    x: 150,
                    lane: 1,
                    jumping: false,
                    shield: false,
                    shieldTime: 0,
                };
                
                this.obstacles = [];
                this.powerups = [];
                this.particles = [];
                
                this.score = 0;
                this.distance = 0;
                this.highScore = parseInt(localStorage.getItem("carGameHighScore") || "0");
                this.baseSpeed = 1;
                this.currentSpeed = 1;
                this.maxSpeed = 8;
                this.minSpeed = 0.5;
                this.jumpsLeft = 0;
                
                this.keys = {};
                this.roadLines = [];
                this.activePowerup = null;
                this.powerupTime = 0;
                
                this.achievements = {
                    firstRace: false,
                    score1000: false,
                    score5000: false,
                    speed10: false,
                    jumpMaster: false,
                    powerupCollector: false,
                    nightRacer: false,
                    perfectRun: false,
                };
                
                this.stats = {
                    gamesPlayed: parseInt(localStorage.getItem("gamesPlayed") || "0"),
                    totalScore: parseInt(localStorage.getItem("totalScore") || "0"),
                    totalDistance: parseInt(localStorage.getItem("totalDistance") || "0"),
                    powerupsCollected: parseInt(localStorage.getItem("powerupsCollected") || "0"),
                    jumpsUsed: parseInt(localStorage.getItem("jumpsUsed") || "0"),
                };
                
                this.isMobile = window.innerWidth <= 768;
                this.lanes = this.calculateLanes();
            }
            
            calculateLanes() {
                // Get the actual road container dimensions
                const roadContainer = document.querySelector('.road-container');
                if (!roadContainer) {
                    // Fallback values
                    const roadWidth = this.isMobile ? 250 : 300;
                    const laneWidth = roadWidth / 4;
                    return [
                        laneWidth * 0.5,
                        laneWidth * 1.5,
                        laneWidth * 2.5,
                        laneWidth * 3.5
                    ];
                }
                
                const roadWidth = roadContainer.offsetWidth;
                const laneWidth = roadWidth / 4;
                
                // Calculate positions relative to road container center
                return [
                    laneWidth * 0.5,    // Lane 0 (leftmost)
                    laneWidth * 1.5,    // Lane 1 
                    laneWidth * 2.5,    // Lane 2
                    laneWidth * 3.5     // Lane 3 (rightmost)
                ];
            }
            
            updateLanes() {
                this.lanes = this.calculateLanes();
                if (this.gameRunning) {
                    this.player.x = this.lanes[this.player.lane];
                    const playerCar = document.getElementById("player-car");
                    const roadContainer = document.querySelector('.road-container');
                    
                    if (playerCar && roadContainer) {
                        // Position car relative to road container
                        const roadRect = roadContainer.getBoundingClientRect();
                        const gameAreaRect = document.getElementById("game-area").getBoundingClientRect();
                        
                        // Calculate position relative to road container
                        const roadLeft = roadRect.left - gameAreaRect.left;
                        const carLeft = roadLeft + this.player.x;
                        
                        playerCar.style.left = carLeft + "px";
                        playerCar.style.bottom = "80px";
                        playerCar.style.transform = "translateX(-50%)";
                    }
                }
            }
        }

        // Initialize game state
        const gameState = new GameState();

        // Track types configuration
        const trackTypes = {
            day: { bg: "#87ceeb", roadClass: "", name: "üåÖ Day Track" },
            night: { bg: "#1a1a2e", roadClass: "night", name: "üåô Night Track" },
            desert: { bg: "#daa520", roadClass: "desert", name: "üèúÔ∏è Desert Track" },
            snow: { bg: "#e6f3ff", roadClass: "snow", name: "‚ùÑÔ∏è Snow Track" },
        };

        // Car SVG Generation
        function createCarSVG(color, type = "sedan", size = "normal") {
            const scale = size === "large" ? 1.3 : (gameState.isMobile ? 0.9 : 1);
            const width = 40 * scale;
            const height = 60 * scale;

            const carTemplates = {
                sedan: `<svg width="${width}" height="${height}" viewBox="0 0 40 60">
                    <rect x="8" y="10" width="24" height="40" fill="${color}" stroke="#000" stroke-width="1.5" rx="5"/>
                    <rect x="6" y="6" width="28" height="10" fill="${color}" stroke="#000" stroke-width="1.5" rx="6"/>
                    <rect x="6" y="44" width="28" height="10" fill="${color}" stroke="#000" stroke-width="1.5" rx="6"/>
                    <circle cx="12" cy="16" r="3" fill="#1a1a1a"/>
                    <circle cx="28" cy="16" r="3" fill="#1a1a1a"/>
                    <circle cx="12" cy="44" r="3" fill="#1a1a1a"/>
                    <circle cx="28" cy="44" r="3" fill="#1a1a1a"/>
                    <rect x="14" y="20" width="12" height="8" fill="#87ceeb" stroke="#000" stroke-width="1" rx="2"/>
                    <rect x="14" y="32" width="12" height="8" fill="#87ceeb" stroke="#000" stroke-width="1" rx="2"/>
                    <rect x="16" y="4" width="8" height="5" fill="#ffd700" stroke="#000" stroke-width="1" rx="1"/>
                    <rect x="16" y="51" width="8" height="5" fill="#ff4500" stroke="#000" stroke-width="1" rx="1"/>
                </svg>`,

                sports: `<svg width="${width}" height="${height}" viewBox="0 0 40 60">
                    <path d="M10 8 L30 8 Q34 12 32 20 L32 40 Q34 48 30 52 L10 52 Q6 48 8 40 L8 20 Q6 12 10 8 Z" fill="${color}" stroke="#000" stroke-width="1.5"/>
                    <circle cx="12" cy="18" r="3" fill="#1a1a1a"/>
                    <circle cx="28" cy="18" r="3" fill="#1a1a1a"/>
                    <circle cx="12" cy="42" r="3" fill="#1a1a1a"/>
                    <circle cx="28" cy="42" r="3" fill="#1a1a1a"/>
                    <path d="M14 22 Q20 20 26 22 L26 28 Q20 26 14 28 Z" fill="#87ceeb" stroke="#000" stroke-width="1"/>
                    <path d="M14 32 Q20 30 26 32 L26 38 Q20 36 14 38 Z" fill="#87ceeb" stroke="#000" stroke-width="1"/>
                    <rect x="16" y="5" width="8" height="6" fill="#ffd700" stroke="#000" stroke-width="1" rx="2"/>
                    <rect x="16" y="49" width="8" height="6" fill="#ff4500" stroke="#000" stroke-width="1" rx="2"/>
                </svg>`,

                suv: `<svg width="${width}" height="${height}" viewBox="0 0 40 60">
                    <rect x="6" y="8" width="28" height="44" fill="${color}" stroke="#000" stroke-width="1.5" rx="5"/>
                    <rect x="8" y="5" width="24" height="12" fill="${color}" stroke="#000" stroke-width="1.5" rx="6"/>
                    <rect x="8" y="43" width="24" height="12" fill="${color}" stroke="#000" stroke-width="1.5" rx="6"/>
                    <circle cx="12" cy="16" r="4" fill="#1a1a1a"/>
                    <circle cx="28" cy="16" r="4" fill="#1a1a1a"/>
                    <circle cx="12" cy="44" r="4" fill="#1a1a1a"/>
                    <circle cx="28" cy="44" r="4" fill="#1a1a1a"/>
                    <rect x="12" y="20" width="16" height="8" fill="#87ceeb" stroke="#000" stroke-width="1" rx="2"/>
                    <rect x="12" y="32" width="16" height="8" fill="#87ceeb" stroke="#000" stroke-width="1" rx="2"/>
                    <rect x="14" y="2" width="12" height="5" fill="#ffd700" stroke="#000" stroke-width="1" rx="1"/>
                    <rect x="14" y="53" width="12" height="5" fill="#ff4500" stroke="#000" stroke-width="1" rx="1"/>
                </svg>`,

                truck: `<svg width="${width}" height="${height}" viewBox="0 0 40 60">
                    <rect x="5" y="6" width="30" height="48" fill="${color}" stroke="#000" stroke-width="1.5" rx="3"/>
                    <rect x="6" y="4" width="28" height="14" fill="${color}" stroke="#000" stroke-width="1.5" rx="5"/>
                    <rect x="6" y="42" width="28" height="14" fill="${color}" stroke="#000" stroke-width="1.5" rx="5"/>
                    <circle cx="12" cy="14" r="4" fill="#1a1a1a"/>
                    <circle cx="28" cy="14" r="4" fill="#1a1a1a"/>
                    <circle cx="12" cy="46" r="4" fill="#1a1a1a"/>
                    <circle cx="28" cy="46" r="4" fill="#1a1a1a"/>
                    <rect x="10" y="20" width="20" height="10" fill="#87ceeb" stroke="#000" stroke-width="1" rx="2"/>
                    <rect x="10" y="32" width="20" height="7" fill="#87ceeb" stroke="#000" stroke-width="1" rx="2"/>
                    <rect x="13" y="1" width="14" height="5" fill="#ffd700" stroke="#000" stroke-width="1" rx="1"/>
                    <rect x="13" y="54" width="14" height="5" fill="#ff4500" stroke="#000" stroke-width="1" rx="1"/>
                </svg>`
            };

            return carTemplates[type] || carTemplates.sedan;
        }

        // Power-up SVG Generation
        function createPowerupSVG(type) {
            const size = gameState.isMobile ? 25 : 30;
            const powerupTemplates = {
                shield: `<svg width="${size}" height="${size}" viewBox="0 0 30 30">
                    <circle cx="15" cy="15" r="13" fill="none" stroke="#00ffff" stroke-width="2"/>
                    <path d="M15 4 L23 11 L20 19 L15 23 L10 19 L7 11 Z" fill="#00ffff" opacity="0.7"/>
                    <text x="15" y="19" text-anchor="middle" fill="white" font-size="10">üõ°</text>
                </svg>`,

                speed: `<svg width="${size}" height="${size}" viewBox="0 0 30 30">
                    <circle cx="15" cy="15" r="13" fill="none" stroke="#ffd700" stroke-width="2"/>
                    <circle cx="15" cy="15" r="9" fill="#ffd700" opacity="0.7"/>
                    <text x="15" y="19" text-anchor="middle" fill="white" font-size="10">‚ö°</text>
                </svg>`,

                jump: `<svg width="${size}" height="${size}" viewBox="0 0 30 30">
                    <circle cx="15" cy="15" r="13" fill="none" stroke="#00ff00" stroke-width="2"/>
                    <circle cx="15" cy="15" r="9" fill="#00ff00" opacity="0.7"/>
                    <text x="15" y="19" text-anchor="middle" fill="white" font-size="10">üöÄ</text>
                </svg>`,

                score: `<svg width="${size}" height="${size}" viewBox="0 0 30 30">
                    <circle cx="15" cy="15" r="13" fill="none" stroke="#ff69b4" stroke-width="2"/>
                    <circle cx="15" cy="15" r="9" fill="#ff69b4" opacity="0.7"/>
                    <text x="15" y="19" text-anchor="middle" fill="white" font-size="10">üí∞</text>
                </svg>`
            };

            return powerupTemplates[type] || powerupTemplates.score;
        }

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll(".screen").forEach(screen => {
                screen.classList.add("hidden");
            });

            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove("hidden");
            }

            switch (screenId) {
                case "menu-screen":
                    updateMenuStats();
                    updateAchievementsPreview();
                    loadStats();
                    break;
                case "select-screen":
                    populateCarSelectionList();
                    break;
                case "garage-screen":
                    populateGarage();
                    break;
                case "achievements-screen":
                    updateAchievementsList();
                    break;
                case "create-screen":
                    resetCarCreator();
                    break;
            }
        }

        // Menu Screen Functions
        function updateMenuStats() {
            const elements = {
                "menu-high-score": gameState.highScore,
                "menu-games-played": gameState.stats.gamesPlayed,
                "menu-total-distance": Math.floor(gameState.stats.totalDistance) + "km",
                "menu-achievements": Object.values(gameState.achievements).filter(Boolean).length + "/8"
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });
        }

        function updateAchievementsPreview() {
            const container = document.getElementById("achievements-preview-list");
            if (!container) return;
            
            const unlockedAchievements = Object.entries(gameState.achievements)
                .filter(([key, unlocked]) => unlocked)
                .slice(0, 3);

            if (unlockedAchievements.length === 0) {
                container.innerHTML = '<p style="color: #a0a0a0; text-align: center;">No achievements unlocked yet</p>';
                return;
            }

            const achievementNames = {
                firstRace: "üèÅ First Race",
                score1000: "üéØ Score Master",
                score5000: "üèÜ High Scorer",
                speed10: "üî• Speed Demon",
                jumpMaster: "üöÄ Jump Master",
                powerupCollector: "üíé Power-up Collector",
                nightRacer: "üåô Night Racer",
                perfectRun: "‚ú® Perfect Run"
            };

            container.innerHTML = unlockedAchievements
                .map(([key]) => `<div style="color: #4a90e2; margin: 5px 0;">${achievementNames[key]}</div>`)
                .join("");
        }

        // Track Selection Setup
        function setupTrackSelection() {
            document.querySelectorAll(".track-option").forEach(option => {
                option.addEventListener("click", function() {
                    document.querySelectorAll(".track-option").forEach(opt => opt.classList.remove("selected"));
                    this.classList.add("selected");
                    gameState.selectedTrack = this.dataset.track;
                });
            });
        }

        // Car Selection Functions
        function populateCarSelectionList() {
            const container = document.getElementById("car-selection-list");
            if (!container) return;
            
            container.innerHTML = "";

            gameState.cars.forEach(car => {
                const carCard = document.createElement("div");
                carCard.className = "car-card";
                carCard.innerHTML = `
                    <div class="car-preview-container">
                        <div class="car-preview">${createCarSVG(car.color, car.type || "sedan")}</div>
                    </div>
                    <div class="car-info">
                        <h4>${car.name}</h4>
                        <div class="car-stats">
                            <div class="car-stat">Type: ${(car.type || "sedan").charAt(0).toUpperCase() + (car.type || "sedan").slice(1)}</div>
                            <div class="car-stat">Speed: ${car.speed || 5}/10</div>
                        </div>
                    </div>
                `;

                carCard.addEventListener("click", () => selectCarAndStartGame(car));
                container.appendChild(carCard);
            });
        }

        function selectCarAndStartGame(car) {
            gameState.currentCar = car;
            gameState.maxSpeed = (car.speed || 5) + 2;
            gameState.minSpeed = Math.max(0.5, (car.speed || 5) * 0.3);
            
            const carNameEl = document.getElementById("current-car-name");
            const trackDisplayEl = document.getElementById("current-track-display");
            
            if (carNameEl) carNameEl.textContent = car.name;
            if (trackDisplayEl) trackDisplayEl.textContent = trackTypes[gameState.selectedTrack].name;
            
            const playerCarEl = document.getElementById("player-car");
            if (playerCarEl) {
                playerCarEl.innerHTML = createCarSVG(car.color, car.type || "sedan");
            }
            
            applyTrackTheme();
            showScreen("game-screen");
            startGame();
        }

        // Garage Functions
        function populateGarage() {
            const container = document.getElementById("garage-car-list");
            if (!container) return;
            
            container.innerHTML = "";

            gameState.cars.forEach((car, index) => {
                const carCard = document.createElement("div");
                carCard.className = "car-card";
                carCard.style.position = "relative";
                carCard.innerHTML = `
                    <div class="car-preview-container">
                        <div class="car-preview">${createCarSVG(car.color, car.type || "sedan")}</div>
                    </div>
                    <div class="car-info">
                        <h4>${car.name}</h4>
                        <div class="car-stats">
                            <div class="car-stat">Type: ${(car.type || "sedan").charAt(0).toUpperCase() + (car.type || "sedan").slice(1)}</div>
                            <div class="car-stat">Speed: ${car.speed || 5}/10</div>
                        </div>
                    </div>
                    ${index >= 3 ? `<button class="btn btn-danger btn-small" onclick="deleteCar(${car.id})" style="position: absolute; top: 10px; right: 10px; margin: 0;">üóëÔ∏è</button>` : ''}
                `;

                container.appendChild(carCard);
            });
        }

        function deleteCar(carId) {
            if (confirm("Are you sure you want to delete this car?")) {
                gameState.cars = gameState.cars.filter(car => car.id !== carId);
                populateGarage();
            }
        }

        function resetGarage() {
            if (confirm("This will delete all custom cars and reset to defaults. Are you sure?")) {
                gameState.cars = [
                    { id: 1, name: "Lightning Bolt", color: "#ff0000", type: "sports", speed: 6 },
                    { id: 2, name: "Night Rider", color: "#000000", type: "sedan", speed: 5 },
                    { id: 3, name: "Desert Storm", color: "#ffd700", type: "suv", speed: 7 },
                ];
                populateGarage();
            }
        }

        // Car Creator Functions
        function setupCarCreator() {
            document.querySelectorAll(".color-option").forEach(option => {
                option.addEventListener("click", function() {
                    document.querySelectorAll(".color-option").forEach(opt => opt.classList.remove("selected"));
                    this.classList.add("selected");
                    gameState.selectedColor = this.dataset.color;
                    updateCarPreview();
                });
            });

            document.querySelectorAll(".car-type-option").forEach(option => {
                option.addEventListener("click", function() {
                    document.querySelectorAll(".car-type-option").forEach(opt => opt.classList.remove("selected"));
                    this.classList.add("selected");
                    gameState.selectedType = this.dataset.type;
                    updateCarPreview();
                });
            });

            const speedSlider = document.getElementById("speed-slider");
            const speedValue = document.getElementById("speed-value");

            if (speedSlider && speedValue) {
                speedSlider.addEventListener("input", function() {
                    gameState.selectedSpeed = parseInt(this.value);
                    speedValue.textContent = this.value;
                });
            }

            const previewIds = ["sedan-preview", "sports-preview", "suv-preview", "truck-preview"];
            const types = ["sedan", "sports", "suv", "truck"];
            
            previewIds.forEach((id, index) => {
                const preview = document.getElementById(id);
                if (preview) {
                    preview.innerHTML = createCarSVG("#888", types[index]);
                }
            });

            updateCarPreview();
        }

        function resetCarCreator() {
            const carNameInput = document.getElementById("car-name");
            const speedSlider = document.getElementById("speed-slider");
            const speedValue = document.getElementById("speed-value");
            
            if (carNameInput) carNameInput.value = "";
            if (speedSlider) speedSlider.value = 5;
            if (speedValue) speedValue.textContent = 5;
            
            gameState.selectedSpeed = 5;
            gameState.selectedColor = "#ff0000";
            gameState.selectedType = "sedan";

            document.querySelectorAll(".color-option").forEach(opt => opt.classList.remove("selected"));
            const redOption = document.querySelector('.color-option[data-color="#ff0000"]');
            if (redOption) redOption.classList.add("selected");
            
            document.querySelectorAll(".car-type-option").forEach(opt => opt.classList.remove("selected"));
            const sedanOption = document.querySelector('.car-type-option[data-type="sedan"]');
            if (sedanOption) sedanOption.classList.add("selected");

            updateCarPreview();
        }

        function updateCarPreview() {
            const preview = document.getElementById("car-preview");
            if (preview) {
                preview.innerHTML = createCarSVG(gameState.selectedColor, gameState.selectedType, "large");
            }
        }

        function saveCar() {
            const nameInput = document.getElementById("car-name");
            const name = nameInput ? nameInput.value.trim() : "";
            
            if (!name) {
                alert("Please enter a car name!");
                return;
            }

            if (name.length > 20) {
                alert("Car name must be 20 characters or less!");
                return;
            }

            const car = {
                id: Date.now(),
                name: name,
                color: gameState.selectedColor,
                type: gameState.selectedType,
                speed: gameState.selectedSpeed,
            };

            gameState.cars.push(car);
            showScreen("garage-screen");
        }

        // Track Theme Application
        function applyTrackTheme() {
            const gameArea = document.getElementById("game-area");
            const road = document.querySelector(".road");
            
            if (!gameArea || !road) return;
            
            const theme = trackTypes[gameState.selectedTrack];
            
            gameArea.className = "game-area";
            road.className = "road";
            
            if (theme.roadClass) {
                gameArea.classList.add(theme.roadClass);
                road.classList.add(theme.roadClass);
            }
        }

        // Game Core Functions
        function startGame() {
            gameState.gameRunning = true;
            gameState.gamePaused = false;
            
            // Update lanes first
            gameState.updateLanes();
            
            // Reset player to center lane (lane 1)
            gameState.player = {
                x: gameState.lanes[1],
                lane: 1,
                jumping: false,
                shield: false,
                shieldTime: 0,
            };
            
            gameState.obstacles = [];
            gameState.powerups = [];
            gameState.particles = [];
            gameState.score = 0;
            gameState.distance = 0;
            gameState.baseSpeed = 0.5; // Start slower
            gameState.currentSpeed = 0.5; // Start slower
            gameState.jumpsLeft = 2; // Start with some jumps
            gameState.activePowerup = null;
            gameState.powerupTime = 0;
            gameState.stats.gamesPlayed++;

            const gameOverModal = document.getElementById("game-over-modal");
            const pauseModal = document.getElementById("pause-modal");
            const highScoreEl = document.getElementById("high-score");
            
            if (gameOverModal) gameOverModal.classList.add("hidden");
            if (pauseModal) pauseModal.classList.add("hidden");
            if (highScoreEl) highScoreEl.textContent = gameState.highScore;

            // Position player car correctly within road container
            setTimeout(() => {
                const playerCar = document.getElementById("player-car");
                const roadContainer = document.querySelector('.road-container');
                
                if (playerCar && roadContainer) {
                    // Position car relative to road container
                    const roadRect = roadContainer.getBoundingClientRect();
                    const gameAreaRect = document.getElementById("game-area").getBoundingClientRect();
                    
                    const roadLeft = roadRect.left - gameAreaRect.left;
                    const carLeft = roadLeft + gameState.player.x;
                    
                    playerCar.style.left = carLeft + "px";
                    playerCar.style.bottom = "80px";
                    playerCar.style.transform = "translateX(-50%)";
                    playerCar.classList.remove("shielded", "jumping");
                }
            }, 100);

            createRoadLines();
            updateMobileControlsState();
            updateHUD();
            
            if (!gameState.achievements.firstRace) {
                gameState.achievements.firstRace = true;
                showAchievement("üèÅ First Race Complete!");
            }
            
            gameLoop();
        }

        function createRoadLines() {
            const road = document.querySelector(".road");
            if (!road) return;
            
            road.innerHTML = "";

            for (let i = 0; i < 30; i++) {
                const line1 = document.createElement("div");
                line1.className = "road-line";
                line1.style.top = (i * 50 - 30) + "px";
                line1.style.animationDelay = (i * 0.1) + "s";
                road.appendChild(line1);

                const line2 = document.createElement("div");
                line2.className = "road-line";
                line2.style.top = (i * 50 - 30) + "px";
                line2.style.animationDelay = (i * 0.1) + "s";
                road.appendChild(line2);
            }
        }

        function pauseGame() {
            if (gameState.gameRunning && !gameState.gamePaused) {
                gameState.gamePaused = true;
                const pauseModal = document.getElementById("pause-modal");
                if (pauseModal) pauseModal.classList.remove("hidden");
            }
        }

        function resumeGame() {
            if (gameState.gamePaused) {
                gameState.gamePaused = false;
                const pauseModal = document.getElementById("pause-modal");
                if (pauseModal) pauseModal.classList.add("hidden");
                gameLoop();
            }
        }

        function restartGame() {
            startGame();
        }

        function gameLoop() {
            if (!gameState.gameRunning || gameState.gamePaused) return;

            handleInput();
            updateSpeed();
            updatePowerups();
            updateObstacles();
            updatePowerupSpawns();
            checkCollisions();
            updateScore();
            updateParticles();
            updateHUD();
            updateMobileControlsState();
            checkAchievements();

            requestAnimationFrame(gameLoop);
        }

        // Input Handling
        function handleInput() {
            if (gameState.keys["ArrowLeft"] && gameState.player.lane > 0) {
                gameState.player.lane--;
                gameState.player.x = gameState.lanes[gameState.player.lane];
                
                const playerCar = document.getElementById("player-car");
                const roadContainer = document.querySelector('.road-container');
                
                if (playerCar && roadContainer) {
                    const roadRect = roadContainer.getBoundingClientRect();
                    const gameAreaRect = document.getElementById("game-area").getBoundingClientRect();
                    
                    const roadLeft = roadRect.left - gameAreaRect.left;
                    const carLeft = roadLeft + gameState.player.x;
                    
                    playerCar.style.left = carLeft + "px";
                    playerCar.style.transform = "translateX(-50%)";
                }
                gameState.keys["ArrowLeft"] = false;
            }

            if (gameState.keys["ArrowRight"] && gameState.player.lane < 3) {
                gameState.player.lane++;
                gameState.player.x = gameState.lanes[gameState.player.lane];
                
                const playerCar = document.getElementById("player-car");
                const roadContainer = document.querySelector('.road-container');
                
                if (playerCar && roadContainer) {
                    const roadRect = roadContainer.getBoundingClientRect();
                    const gameAreaRect = document.getElementById("game-area").getBoundingClientRect();
                    
                    const roadLeft = roadRect.left - gameAreaRect.left;
                    const carLeft = roadLeft + gameState.player.x;
                    
                    playerCar.style.left = carLeft + "px";
                    playerCar.style.transform = "translateX(-50%)";
                }
                gameState.keys["ArrowRight"] = false;
            }

            if ((gameState.keys[" "] || gameState.keys["Space"]) && gameState.jumpsLeft > 0 && !gameState.player.jumping) {
                jump();
                gameState.keys[" "] = false;
                gameState.keys["Space"] = false;
            }

            if (gameState.keys["KeyP"]) {
                pauseGame();
                gameState.keys["KeyP"] = false;
            }
        }

        // Speed Management
        function updateSpeed() {
            let speedMultiplier = 1;
            
            switch (gameState.selectedTrack) {
                case "snow":
                    speedMultiplier = 0.8;
                    break;
                case "desert":
                    speedMultiplier = 1.2;
                    break;
            }

            if (gameState.activePowerup === "speed") {
                speedMultiplier *= 1.8;
            }

            // Manual speed control
            if (gameState.keys["ArrowUp"]) {
                gameState.currentSpeed = Math.min(
                    gameState.currentSpeed + 0.05,
                    gameState.maxSpeed * speedMultiplier
                );
            }

            if (gameState.keys["ArrowDown"]) {
                gameState.currentSpeed = Math.max(
                    gameState.currentSpeed - 0.1,
                    gameState.minSpeed
                );
            }

            // Gradual natural acceleration (slower progression)
            const scoreBasedSpeed = Math.min(gameState.score / 2000, 3); // Max +3 speed from score
            const targetSpeed = (gameState.baseSpeed + scoreBasedSpeed) * speedMultiplier;
            
            if (gameState.currentSpeed < targetSpeed) {
                gameState.currentSpeed = Math.min(
                    gameState.currentSpeed + 0.002, // Much slower acceleration
                    targetSpeed
                );
            }
        }

        // Power-up Management
        function updatePowerups() {
            if (gameState.activePowerup) {
                gameState.powerupTime--;
                if (gameState.powerupTime <= 0) {
                    deactivatePowerup();
                }
            }

            if (gameState.player.shield && gameState.player.shieldTime > 0) {
                gameState.player.shieldTime--;
                if (gameState.player.shieldTime <= 0) {
                    gameState.player.shield = false;
                    const playerCar = document.getElementById("player-car");
                    if (playerCar) playerCar.classList.remove("shielded");
                }
            }
        }

        function updatePowerupSpawns() {
            if (Math.random() < 0.015) {
                const roadContainer = document.querySelector('.road-container');
                if (!roadContainer) return;
                
                const roadRect = roadContainer.getBoundingClientRect();
                const gameAreaRect = document.getElementById("game-area").getBoundingClientRect();
                const roadLeft = roadRect.left - gameAreaRect.left;
                
                const powerupTypes = ["shield", "speed", "jump", "jump", "score"];
                const powerup = {
                    id: Date.now(),
                    type: powerupTypes[Math.floor(Math.random() * powerupTypes.length)],
                    lane: Math.floor(Math.random() * 4),
                    x: roadLeft + gameState.lanes[Math.floor(Math.random() * 4)],
                    y: -40,
                    element: null,
                };

                const element = document.createElement("div");
                element.className = "powerup";
                element.innerHTML = createPowerupSVG(powerup.type);
                element.style.left = powerup.x + "px";
                element.style.top = powerup.y + "px";
                element.style.position = "absolute";
                element.style.transform = "translateX(-50%)";
                const gameArea = document.getElementById("game-area");
                if (gameArea) gameArea.appendChild(element);

                powerup.element = element;
                gameState.powerups.push(powerup);
            }

            gameState.powerups = gameState.powerups.filter(powerup => {
                powerup.y += gameState.currentSpeed * 2 + 3;
                if (powerup.element) {
                    powerup.element.style.top = powerup.y + "px";
                }

                if (powerup.y > window.innerHeight) {
                    if (powerup.element && powerup.element.parentNode) {
                        powerup.element.remove();
                    }
                    return false;
                }
                return true;
            });
        }

        function jump() {
            if (gameState.jumpsLeft > 0 && !gameState.player.jumping) {
                gameState.player.jumping = true;
                gameState.jumpsLeft--;
                gameState.stats.jumpsUsed++;
                
                const playerCar = document.getElementById("player-car");
                if (playerCar) {
                    playerCar.classList.add("jumping");
                    // Add speed burst effect
                    playerCar.classList.add("speed-burst");
                }

                // Create jump particles
                setTimeout(() => {
                    const roadContainer = document.querySelector('.road-container');
                    if (roadContainer) {
                        const roadRect = roadContainer.getBoundingClientRect();
                        const gameAreaRect = document.getElementById("game-area").getBoundingClientRect();
                        const roadLeft = roadRect.left - gameAreaRect.left;
                        const carLeft = roadLeft + gameState.player.x;
                        
                        createParticles(carLeft, window.innerHeight * 0.75, "#00ff00", 20);
                        createParticles(carLeft, window.innerHeight * 0.75, "#ffff00", 15);
                    }
                }, 200);

                setTimeout(() => {
                    gameState.player.jumping = false;
                    const playerCar = document.getElementById("player-car");
                    if (playerCar) {
                        playerCar.classList.remove("jumping", "speed-burst");
                    }
                }, 800);
            }
        }

        // Obstacle Management
        function updateObstacles() {
            const difficultyMultiplier = 1 + gameState.score / 5000;
            const obstacleChance = (0.008 + gameState.currentSpeed * 0.002) * difficultyMultiplier;

            if (Math.random() < obstacleChance) {
                const roadContainer = document.querySelector('.road-container');
                if (!roadContainer) return;
                
                const roadRect = roadContainer.getBoundingClientRect();
                const gameAreaRect = document.getElementById("game-area").getBoundingClientRect();
                const roadLeft = roadRect.left - gameAreaRect.left;
                
                const obstacle = {
                    id: Date.now(),
                    lane: Math.floor(Math.random() * 4),
                    x: roadLeft + gameState.lanes[Math.floor(Math.random() * 4)],
                    y: -75,
                    element: null,
                };

                const element = document.createElement("div");
                element.className = "obstacle";
                const carTypes = ["sedan", "sports", "suv", "truck"];
                const obstacleColors = ["#ff0000", "#ff4500", "#8b0000", "#dc143c"];
                const randomType = carTypes[Math.floor(Math.random() * 4)];
                const randomColor = obstacleColors[Math.floor(Math.random() * obstacleColors.length)];
                
                element.innerHTML = createCarSVG(randomColor, randomType);
                element.style.left = obstacle.x + "px";
                element.style.top = obstacle.y + "px";
                element.style.position = "absolute";
                element.style.transform = "translateX(-50%)";
                const gameArea = document.getElementById("game-area");
                if (gameArea) gameArea.appendChild(element);

                obstacle.element = element;
                gameState.obstacles.push(obstacle);
            }

            gameState.obstacles = gameState.obstacles.filter(obstacle => {
                obstacle.y += gameState.currentSpeed * 3 + 4;
                if (obstacle.element) {
                    obstacle.element.style.top = obstacle.y + "px";
                }

                if (obstacle.y > window.innerHeight) {
                    if (obstacle.element && obstacle.element.parentNode) {
                        obstacle.element.remove();
                    }
                    return false;
                }
                return true;
            });
        }

        // Collision Detection
        function checkCollisions() {
            const playerY = window.innerHeight * 0.8;
            const roadContainer = document.querySelector('.road-container');
            if (!roadContainer) return;
            
            const roadRect = roadContainer.getBoundingClientRect();
            const gameAreaRect = document.getElementById("game-area").getBoundingClientRect();
            const roadLeft = roadRect.left - gameAreaRect.left;
            const playerCarX = roadLeft + gameState.player.x;

            // Obstacle collisions (only when not jumping and not shielded)
            if (!gameState.player.jumping && !gameState.player.shield) {
                gameState.obstacles.forEach((obstacle, index) => {
                    if (
                        Math.abs(obstacle.x - playerCarX) < 30 &&
                        obstacle.y > playerY - 40 &&
                        obstacle.y < playerY + 40
                    ) {
                        // Create crash blast animation
                        createCrashBlast(obstacle.x, obstacle.y, playerCarX, playerY);
                        
                        // Remove the obstacle immediately
                        if (obstacle.element && obstacle.element.parentNode) {
                            obstacle.element.remove();
                        }
                        gameState.obstacles.splice(index, 1);
                        
                        // Game over after short animation delay
                        setTimeout(() => {
                            gameOver();
                        }, 800);
                        return;
                    }
                });
            }

            // Power-up collisions
            gameState.powerups = gameState.powerups.filter((powerup, index) => {
                if (
                    Math.abs(powerup.x - playerCarX) < 35 &&
                    powerup.y > playerY - 35 &&
                    powerup.y < playerY + 35
                ) {
                    collectPowerup(powerup);
                    if (powerup.element && powerup.element.parentNode) {
                        powerup.element.remove();
                    }
                    return false;
                }
                return true;
            });
        }

        function createCrashBlast(obstacleX, obstacleY, playerX, playerY) {
            const gameArea = document.getElementById("game-area");
            if (!gameArea) return;
            
            // Calculate crash point
            const crashX = (obstacleX + playerX) / 2;
            const crashY = (obstacleY + playerY) / 2;
            
            // Stop the game immediately
            gameState.gameRunning = false;
            
            // Create screen flash
            gameArea.classList.add("impact-flash");
            setTimeout(() => gameArea.classList.remove("impact-flash"), 600);
            
            // Create explosion particles
            for (let wave = 0; wave < 4; wave++) {
                setTimeout(() => {
                    createParticles(crashX, crashY, "#ff0000", 20);
                    createParticles(crashX, crashY, "#ff4500", 15);
                    createParticles(crashX, crashY, "#ffd700", 12);
                    createParticles(crashX, crashY, "#ffffff", 8);
                }, wave * 100);
            }
            
            // Create explosion rings
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const ring = document.createElement("div");
                    ring.style.cssText = `
                        position: absolute;
                        left: ${crashX - 30 - (i * 10)}px;
                        top: ${crashY - 30 - (i * 10)}px;
                        width: ${60 + (i * 20)}px;
                        height: ${60 + (i * 20)}px;
                        border: ${3 + i}px solid ${i % 2 ? "#ff0000" : "#ffd700"};
                        border-radius: 50%;
                        z-index: 30;
                        pointer-events: none;
                        animation: explosionRing 1s ease-out forwards;
                    `;
                    
                    gameArea.appendChild(ring);
                    setTimeout(() => ring.remove(), 1000);
                }, i * 120);
            }
            
            // Show dramatic crash text
            setTimeout(() => {
                const crashText = document.createElement("div");
                crashText.style.cssText = `
                    position: absolute;
                    left: 50%;
                    top: 40%;
                    transform: translate(-50%, -50%);
                    font-size: 3rem;
                    font-weight: 900;
                    color: #ff0000;
                    text-shadow: 
                        2px 2px 0 #000,
                        -2px -2px 0 #000,
                        2px -2px 0 #000,
                        -2px 2px 0 #000,
                        0 0 15px #ff0000;
                    z-index: 50;
                    pointer-events: none;
                    font-family: 'Arial Black', Arial, sans-serif;
                    animation: crashTextAppear 1.5s ease-out forwards;
                `;
                crashText.textContent = "CRASH!";
                
                gameArea.appendChild(crashText);
                setTimeout(() => crashText.remove(), 1500);
            }, 200);
        }

        function startCrashSequence(obstacle, obstacleIndex, playerCarX, playerY) {
            // Stop the game immediately
            gameState.gameRunning = false;
            
            // Get references
            const gameArea = document.getElementById("game-area");
            const playerCar = document.getElementById("player-car");
            const screen = document.querySelector('.screen:not(.hidden)');
            
            // Phase 1: Impact flash and screen shake (0-0.5s)
            if (gameArea) {
                gameArea.classList.add("impact-flash");
            }
            if (screen) {
                screen.classList.add("screen-shake");
            }
            
            // Phase 2: Car animations (0.2s)
            setTimeout(() => {
                if (playerCar) {
                    playerCar.classList.add("player-crash");
                }
                if (obstacle.element) {
                    obstacle.element.classList.add("obstacle-destroy");
                }
                
                // Create massive explosion effect
                createMassiveExplosion(obstacle.x, obstacle.y, playerCarX, playerY);
            }, 200);
            
            // Phase 3: Show crash text (0.5s)
            setTimeout(() => {
                showDramaticCrashText(obstacle.x, obstacle.y);
            }, 500);
            
            // Phase 4: Clean up effects (1.2s)
            setTimeout(() => {
                if (gameArea) {
                    gameArea.classList.remove("impact-flash");
                }
                if (screen) {
                    screen.classList.remove("screen-shake");
                }
                if (playerCar) {
                    playerCar.classList.remove("player-crash");
                }
            }, 1200);
            
            // Phase 5: Remove obstacle and trigger game over (1.5s)
            setTimeout(() => {
                if (obstacle.element && obstacle.element.parentNode) {
                    obstacle.element.remove();
                }
                gameState.obstacles.splice(obstacleIndex, 1);
                
                // Trigger game over after full crash sequence
                setTimeout(() => {
                    gameOver();
                }, 500);
            }, 1500);
        }

        function createMassiveExplosion(obstacleX, obstacleY, playerX, playerY) {
            const crashX = (obstacleX + playerX) / 2;
            const crashY = (obstacleY + playerY) / 2;
            const gameArea = document.getElementById("game-area");
            
            // Create multiple explosion waves
            for (let wave = 0; wave < 6; wave++) {
                setTimeout(() => {
                    // Particles for this wave
                    createParticles(crashX, crashY, "#ff0000", 25);
                    createParticles(crashX, crashY, "#ff4500", 20);
                    createParticles(crashX, crashY, "#ffd700", 15);
                    createParticles(crashX, crashY, "#ffffff", 10);
                    createParticles(crashX, crashY, "#ff8c00", 12);
                    
                    // Expanding rings
                    const ring = document.createElement("div");
                    ring.style.cssText = `
                        position: absolute;
                        left: ${crashX - 40}px;
                        top: ${crashY - 40}px;
                        width: 80px;
                        height: 80px;
                        border: ${4 + wave}px solid ${wave % 2 ? "#ff0000" : "#ffd700"};
                        border-radius: 50%;
                        z-index: 30;
                        pointer-events: none;
                        animation: explosionRing 1s ease-out forwards;
                    `;
                    
                    if (gameArea) gameArea.appendChild(ring);
                    setTimeout(() => ring.remove(), 1000);
                }, wave * 150);
            }
            
            // Create debris effect
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const debris = document.createElement("div");
                    const angle = (i * 30) * Math.PI / 180;
                    debris.style.cssText = `
                        position: absolute;
                        left: ${crashX}px;
                        top: ${crashY}px;
                        width: 6px;
                        height: 6px;
                        background: ${i % 3 === 0 ? "#ff0000" : i % 3 === 1 ? "#ffd700" : "#ff4500"};
                        border-radius: 50%;
                        z-index: 25;
                        pointer-events: none;
                        animation: debrisFly 1.5s ease-out forwards;
                        --angle: ${angle}rad;
                    `;
                    
                    if (gameArea) gameArea.appendChild(debris);
                    setTimeout(() => debris.remove(), 1500);
                }, i * 50);
            }
        }

        function showDramaticCrashText(x, y) {
            const gameArea = document.getElementById("game-area");
            if (!gameArea) return;
            
            const crashText = document.createElement("div");
            crashText.style.cssText = `
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                font-size: 4rem;
                font-weight: 900;
                color: #ff0000;
                text-shadow: 
                    3px 3px 0 #000,
                    -3px -3px 0 #000,
                    3px -3px 0 #000,
                    -3px 3px 0 #000,
                    0 0 20px #ff0000,
                    0 0 40px #ff0000;
                z-index: 50;
                pointer-events: none;
                font-family: 'Arial Black', Arial, sans-serif;
                letter-spacing: 0.2em;
            `;
            crashText.textContent = "CRASH!";
            crashText.classList.add("crash-text");
            
            gameArea.appendChild(crashText);
            
            // Remove crash text after animation
            setTimeout(() => {
                if (crashText.parentNode) {
                    crashText.remove();
                }
            }, 2000);
        }

        function collectPowerup(powerup) {
            gameState.stats.powerupsCollected++;
            
            // Create fireworks effect immediately
            createFireworks(powerup.x, powerup.y, powerup.type);
            
            // Remove the powerup element
            if (powerup.element && powerup.element.parentNode) {
                powerup.element.remove();
            }
            
            // Add visual feedback to player car
            const playerCar = document.getElementById("player-car");
            
            switch (powerup.type) {
                case "shield":
                    gameState.player.shield = true;
                    gameState.player.shieldTime = 300;
                    if (playerCar) {
                        playerCar.classList.add("shielded");
                    }
                    showFloatingText("SHIELD ACTIVATED!", powerup.x, powerup.y, "#00ffff");
                    break;
                case "speed":
                    activatePowerup("speed", 360);
                    if (playerCar) {
                        playerCar.classList.add("speed-burst");
                        setTimeout(() => playerCar.classList.remove("speed-burst"), 600);
                    }
                    showFloatingText("SPEED BOOST!", powerup.x, powerup.y, "#ffd700");
                    break;
                case "jump":
                    gameState.jumpsLeft = Math.min(gameState.jumpsLeft + 3, 5);
                    showFloatingText("+3 JUMPS!", powerup.x, powerup.y, "#00ff00");
                    break;
                case "score":
                    gameState.score += 500;
                    showFloatingText("+500 POINTS!", powerup.x, powerup.y, "#ff69b4");
                    break;
            }

            if (gameState.stats.powerupsCollected >= 10 && !gameState.achievements.powerupCollector) {
                gameState.achievements.powerupCollector = true;
                showAchievement("üíé Power-up Collector!");
            }
        }

        function createFireworks(x, y, type) {
            const gameArea = document.getElementById("game-area");
            if (!gameArea) return;
            
            const colorSets = {
                shield: ["#00ffff", "#0080ff", "#40e0d0"],
                speed: ["#ffd700", "#ffff00", "#ffa500"], 
                jump: ["#00ff00", "#32cd32", "#00fa9a"],
                score: ["#ff69b4", "#ff1493", "#da70d6"]
            };
            
            const colors = colorSets[type] || colorSets.score;
            
            // Main firework explosion
            setTimeout(() => {
                // Center burst
                const center = document.createElement("div");
                center.style.cssText = `
                    position: absolute;
                    left: ${x - 6}px;
                    top: ${y - 6}px;
                    width: 12px;
                    height: 12px;
                    background: ${colors[0]};
                    border-radius: 50%;
                    z-index: 35;
                    box-shadow: 0 0 15px ${colors[0]};
                    animation: fireworkCenter 1.2s ease-out forwards;
                `;
                gameArea.appendChild(center);
                setTimeout(() => {
                    if (center.parentNode) center.remove();
                }, 1200);
                
                // Radiating trails
                for (let i = 0; i < 16; i++) {
                    const angle = (i * 22.5) * Math.PI / 180;
                    const distance = 60 + Math.random() * 30;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    const trail = document.createElement("div");
                    trail.style.cssText = `
                        position: absolute;
                        left: ${x - 1}px;
                        top: ${y - 10}px;
                        width: 2px;
                        height: 15px;
                        background: linear-gradient(to bottom, ${color}, transparent);
                        border-radius: 50%;
                        z-index: 30;
                        pointer-events: none;
                        transform-origin: bottom center;
                        animation: fireworkTrail 1.5s ease-out forwards;
                        --angle: ${angle}rad;
                        --distance: ${distance}px;
                    `;
                    
                    gameArea.appendChild(trail);
                    setTimeout(() => {
                        if (trail.parentNode) trail.remove();
                    }, 1500);
                    
                    // Sparkle at end of trail
                    setTimeout(() => {
                        const endX = x + Math.cos(angle) * distance;
                        const endY = y + Math.sin(angle) * distance;
                        
                        const sparkle = document.createElement("div");
                        sparkle.style.cssText = `
                            position: absolute;
                            left: ${endX - 2}px;
                            top: ${endY - 2}px;
                            width: 4px;
                            height: 4px;
                            background: ${color};
                            border-radius: 50%;
                            z-index: 32;
                            box-shadow: 0 0 6px ${color};
                            animation: sparkleEnd 0.8s ease-out forwards;
                        `;
                        
                        gameArea.appendChild(sparkle);
                        setTimeout(() => {
                            if (sparkle.parentNode) sparkle.remove();
                        }, 800);
                    }, 400 + Math.random() * 200);
                }
                
                // Falling sparkles
                setTimeout(() => {
                    for (let i = 0; i < 8; i++) {
                        const fallX = x + (Math.random() - 0.5) * 80;
                        const fallY = y - 10;
                        const fallColor = colors[Math.floor(Math.random() * colors.length)];
                        
                        const falling = document.createElement("div");
                        falling.style.cssText = `
                            position: absolute;
                            left: ${fallX}px;
                            top: ${fallY}px;
                            width: 2px;
                            height: 2px;
                            background: ${fallColor};
                            border-radius: 50%;
                            z-index: 26;
                            box-shadow: 0 0 3px ${fallColor};
                            animation: fireworkFall 1.5s ease-in forwards;
                        `;
                        
                        gameArea.appendChild(falling);
                        setTimeout(() => {
                            if (falling.parentNode) falling.remove();
                        }, 1500);
                    }
                }, 600);
                
            }, 50);
        }

        function createShieldActivationEffect() {
            const gameArea = document.getElementById("game-area");
            if (!gameArea) return;
            
            // Screen-wide shield effect
            const shieldOverlay = document.createElement("div");
            shieldOverlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle, transparent 30%, rgba(0, 255, 255, 0.3) 70%);
                z-index: 15;
                pointer-events: none;
                animation: shieldWave 1s ease-out forwards;
            `;
            
            gameArea.appendChild(shieldOverlay);
            setTimeout(() => shieldOverlay.remove(), 1000);
        }

        function createSpeedBoostEffect() {
            const gameArea = document.getElementById("game-area");
            if (!gameArea) return;
            
            // Speed lines effect
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const speedLine = document.createElement("div");
                    speedLine.style.cssText = `
                        position: absolute;
                        left: ${Math.random() * 100}%;
                        top: -5px;
                        width: 3px;
                        height: 50px;
                        background: linear-gradient(to bottom, transparent, #ffd700, transparent);
                        z-index: 12;
                        pointer-events: none;
                        animation: speedLineMove 0.5s ease-out forwards;
                    `;
                    
                    gameArea.appendChild(speedLine);
                    setTimeout(() => speedLine.remove(), 500);
                }, i * 50);
            }
        }

        function createJumpBoostEffect() {
            const gameArea = document.getElementById("game-area");
            if (!gameArea) return;
            
            // Upward energy burst
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const jumpBurst = document.createElement("div");
                    jumpBurst.style.cssText = `
                        position: absolute;
                        left: 50%;
                        bottom: 20%;
                        width: 8px;
                        height: 8px;
                        background: #00ff00;
                        border-radius: 50%;
                        z-index: 20;
                        pointer-events: none;
                        animation: jumpBurstUp 1s ease-out forwards;
                        transform: translateX(-50%);
                        --offset: ${(i - 3) * 20}px;
                    `;
                    
                    gameArea.appendChild(jumpBurst);
                    setTimeout(() => jumpBurst.remove(), 1000);
                }, i * 80);
            }
        }

        function createScoreBoostEffect(x, y) {
            const gameArea = document.getElementById("game-area");
            if (!gameArea) return;
            
            // Flying score particles
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const scoreParticle = document.createElement("div");
                    scoreParticle.style.cssText = `
                        position: absolute;
                        left: ${x}px;
                        top: ${y}px;
                        width: 6px;
                        height: 6px;
                        background: #ff69b4;
                        border-radius: 50%;
                        z-index: 25;
                        pointer-events: none;
                        animation: scoreFloat 1.5s ease-out forwards;
                        --random-x: ${(Math.random() - 0.5) * 100}px;
                        --random-y: ${-Math.random() * 80}px;
                    `;
                    
                    gameArea.appendChild(scoreParticle);
                    setTimeout(() => scoreParticle.remove(), 1500);
                }, i * 50);
            }
        }

        function showFloatingText(text, x, y, color) {
            const floatingText = document.createElement("div");
            floatingText.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                color: ${color};
                font-weight: bold;
                font-size: 14px;
                z-index: 30;
                pointer-events: none;
                transform: translateX(-50%);
                animation: floatUp 2s ease-out forwards;
            `;
            floatingText.textContent = text;
            
            const gameArea = document.getElementById("game-area");
            if (gameArea) {
                gameArea.appendChild(floatingText);
                setTimeout(() => floatingText.remove(), 2000);
            }
        }

        function createCollectionEffect(x, y, type) {
            const colors = {
                shield: "#00ffff",
                speed: "#ffd700", 
                jump: "#00ff00",
                score: "#ff69b4"
            };
            
            // Create burst of particles
            createParticles(x, y, colors[type] || "#ffd700", 25);
            createParticles(x, y, "#ffffff", 15);
            
            // Create multiple expanding rings
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const ring = document.createElement("div");
                    ring.style.cssText = `
                        position: absolute;
                        left: ${x - 20}px;
                        top: ${y - 20}px;
                        width: 40px;
                        height: 40px;
                        border: 3px solid ${colors[type] || "#ffd700"};
                        border-radius: 50%;
                        z-index: 25;
                        pointer-events: none;
                        animation: collectEffect 0.8s ease-out forwards;
                    `;
                    
                    const gameArea = document.getElementById("game-area");
                    if (gameArea) gameArea.appendChild(ring);
                    
                    setTimeout(() => ring.remove(), 800);
                }, i * 150);
            }
            
            // Create starburst effect
            for (let i = 0; i < 8; i++) {
                const angle = (i * 45) * Math.PI / 180;
                const sparkle = document.createElement("div");
                sparkle.style.cssText = `
                    position: absolute;
                    left: ${x}px;
                    top: ${y}px;
                    width: 4px;
                    height: 4px;
                    background: ${colors[type] || "#ffd700"};
                    border-radius: 50%;
                    z-index: 20;
                    pointer-events: none;
                    animation: sparkleOut 1s ease-out forwards;
                    transform-origin: center;
                    --angle: ${angle}rad;
                `;
                
                const gameArea = document.getElementById("game-area");
                if (gameArea) gameArea.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        function activatePowerup(type, duration) {
            gameState.activePowerup = type;
            gameState.powerupTime = duration;
        }

        function deactivatePowerup() {
            gameState.activePowerup = null;
            gameState.powerupTime = 0;
        }

        // Particle System
        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                const particle = {
                    x: x + (Math.random() - 0.5) * 20,
                    y: y + (Math.random() - 0.5) * 20,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 60,
                    color: color,
                    element: null,
                };

                const element = document.createElement("div");
                element.className = "particle";
                element.style.left = particle.x + "px";
                element.style.top = particle.y + "px";
                element.style.background = color;
                const particlesContainer = document.getElementById("particles");
                if (particlesContainer) particlesContainer.appendChild(element);

                particle.element = element;
                gameState.particles.push(particle);
            }
        }

        function updateParticles() {
            gameState.particles = gameState.particles.filter(particle => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life--;

                particle.element.style.left = particle.x + "px";
                particle.element.style.top = particle.y + "px";
                particle.element.style.opacity = particle.life / 60;

                if (particle.life <= 0) {
                    particle.element.remove();
                    return false;
                }
                return true;
            });
        }

        // Score Management
        function updateScore() {
            gameState.score += gameState.currentSpeed * 0.3; // Slower score increase
            gameState.distance += gameState.currentSpeed * 0.08; // Slower distance
            gameState.stats.totalScore += gameState.currentSpeed * 0.3;
            gameState.stats.totalDistance += gameState.currentSpeed * 0.08;

            // Slower difficulty increase
            if (Math.floor(gameState.score) % 2000 === 0 && Math.floor(gameState.score) > 0) {
                gameState.baseSpeed += 0.05; // Much smaller increases
                showFloatingText("LEVEL UP!", 300, 200, "#ffd700");
            }
        }

        // UI Updates
        function updateHUD() {
            const elements = {
                "score": Math.floor(gameState.score),
                "high-score": gameState.highScore,
                "jumps": gameState.jumpsLeft
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });

            const jumpsHUD = document.getElementById("jumps-display");
            if (jumpsHUD) {
                jumpsHUD.className = "hud-item";
                if (gameState.jumpsLeft === 1) {
                    jumpsHUD.classList.add("warning");
                } else if (gameState.jumpsLeft === 0) {
                    jumpsHUD.classList.add("danger");
                }
            }
        }

        function updateMobileControlsState() {
            const jumpBtn = document.getElementById("jump-btn");
            if (jumpBtn) {
                if (gameState.jumpsLeft <= 0) {
                    jumpBtn.classList.add("disabled");
                } else {
                    jumpBtn.classList.remove("disabled");
                }
            }
        }

        // Mobile Controls Setup
        function setupMobileControls() {
            const controlButtons = {
                "left-btn": () => gameState.keys["ArrowLeft"] = true,
                "right-btn": () => gameState.keys["ArrowRight"] = true,
                "speed-btn": () => gameState.keys["ArrowUp"] = true,
                "brake-btn": () => gameState.keys["ArrowDown"] = true,
                "jump-btn": () => {
                    if (gameState.jumpsLeft > 0) {
                        jump();
                    }
                }
            };

            Object.entries(controlButtons).forEach(([id, action]) => {
                const btn = document.getElementById(id);
                if (!btn) return;
                
                btn.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    if (id !== "jump-btn") {
                        action();
                    } else {
                        action();
                    }
                });

                btn.addEventListener("touchend", (e) => {
                    e.preventDefault();
                    if (id !== "jump-btn") {
                        const key = id === "left-btn" ? "ArrowLeft" :
                                   id === "right-btn" ? "ArrowRight" :
                                   id === "speed-btn" ? "ArrowUp" :
                                   id === "brake-btn" ? "ArrowDown" : null;
                        if (key) gameState.keys[key] = false;
                    }
                });

                btn.addEventListener("mousedown", action);
                btn.addEventListener("mouseup", () => {
                    if (id !== "jump-btn") {
                        const key = id === "left-btn" ? "ArrowLeft" :
                                   id === "right-btn" ? "ArrowRight" :
                                   id === "speed-btn" ? "ArrowUp" :
                                   id === "brake-btn" ? "ArrowDown" : null;
                        if (key) gameState.keys[key] = false;
                    }
                });
            });
        }

        // Achievement System
        function checkAchievements() {
            if (gameState.score >= 1000 && !gameState.achievements.score1000) {
                gameState.achievements.score1000 = true;
                showAchievement("üéØ Score Master!");
            }

            if (gameState.score >= 5000 && !gameState.achievements.score5000) {
                gameState.achievements.score5000 = true;
                showAchievement("üèÜ High Scorer!");
            }

            if (gameState.currentSpeed >= 10 && !gameState.achievements.speed10) {
                gameState.achievements.speed10 = true;
                showAchievement("üî• Speed Demon!");
            }

            if (gameState.stats.jumpsUsed >= 20 && !gameState.achievements.jumpMaster) {
                gameState.achievements.jumpMaster = true;
                showAchievement("üöÄ Jump Master!");
            }

            if (gameState.selectedTrack === "night" && !gameState.achievements.nightRacer) {
                gameState.achievements.nightRacer = true;
                showAchievement("üåô Night Racer!");
            }
        }

        function showAchievement(text) {
            const achievement = document.createElement("div");
            achievement.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: #ffffff;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 4px 20px rgba(40, 167, 69, 0.5);
                transform: translateX(100%);
                transition: transform 0.5s ease;
                max-width: 250px;
                font-size: 14px;
            `;
            achievement.textContent = text;
            document.body.appendChild(achievement);

            setTimeout(() => {
                achievement.style.transform = "translateX(0)";
            }, 100);

            setTimeout(() => {
                achievement.style.transform = "translateX(100%)";
                setTimeout(() => {
                    achievement.remove();
                }, 500);
            }, 3000);
        }

        function updateAchievementsList() {
            const container = document.getElementById("achievements-list");
            if (!container) return;
            
            container.innerHTML = "";

            const achievementData = [
                { key: "firstRace", name: "First Race", desc: "Complete your first race", icon: "üèÅ" },
                { key: "score1000", name: "Score Master", desc: "Reach 1000 points", icon: "üéØ" },
                { key: "score5000", name: "High Scorer", desc: "Reach 5000 points", icon: "üèÜ" },
                { key: "speed10", name: "Speed Demon", desc: "Reach speed 10.0", icon: "üî•" },
                { key: "jumpMaster", name: "Jump Master", desc: "Use 20 jumps total", icon: "üöÄ" },
                { key: "powerupCollector", name: "Power-up Collector", desc: "Collect 10 power-ups", icon: "üíé" },
                { key: "nightRacer", name: "Night Racer", desc: "Race on night track", icon: "üåô" },
                { key: "perfectRun", name: "Perfect Run", desc: "Complete a perfect run", icon: "‚ú®" },
            ];

            achievementData.forEach(achievement => {
                const div = document.createElement("div");
                div.className = "achievement" + (gameState.achievements[achievement.key] ? " unlocked" : "");
                div.innerHTML = `
                    <div class="icon">${achievement.icon}</div>
                    <div class="info">
                        <h4>${achievement.name}</h4>
                        <p>${achievement.desc}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Game Over
        function gameOver() {
            gameState.gameRunning = false;
            
            saveStats();

            const finalScore = Math.floor(gameState.score);
            const finalDistance = Math.floor(gameState.distance);
            const newHighScoreBadge = document.getElementById("new-high-score-badge");
            
            if (finalScore > gameState.highScore) {
                gameState.highScore = finalScore;
                localStorage.setItem("carGameHighScore", gameState.highScore.toString());
                if (newHighScoreBadge) newHighScoreBadge.classList.remove("hidden");
            } else {
                if (newHighScoreBadge) newHighScoreBadge.classList.add("hidden");
            }

            const finalScoreEl = document.getElementById("final-score");
            const finalDistanceEl = document.getElementById("final-distance");
            const gameOverModal = document.getElementById("game-over-modal");
            
            if (finalScoreEl) finalScoreEl.textContent = finalScore;
            if (finalDistanceEl) finalDistanceEl.textContent = finalDistance + "km";
            
            // Show game over modal after short delay to see the crash
            if (gameOverModal) {
                setTimeout(() => {
                    gameOverModal.classList.remove("hidden");
                }, 300);
            }

            // Clean up remaining game objects
            gameState.obstacles.forEach(obstacle => {
                if (obstacle.element && obstacle.element.parentNode) {
                    obstacle.element.remove();
                }
            });
            gameState.powerups.forEach(powerup => {
                if (powerup.element && powerup.element.parentNode) {
                    powerup.element.remove();
                }
            });
            gameState.obstacles = [];
            gameState.powerups = [];
        }

        function createCrashEffect(obstacleX, obstacleY, playerX, playerY) {
            // This function is now replaced by startCrashSequence
            // Keeping for compatibility but functionality moved to startCrashSequence
        }

        // Data Persistence
        function saveStats() {
            localStorage.setItem("gamesPlayed", gameState.stats.gamesPlayed.toString());
            localStorage.setItem("totalScore", Math.floor(gameState.stats.totalScore).toString());
            localStorage.setItem("totalDistance", Math.floor(gameState.stats.totalDistance).toString());
            localStorage.setItem("powerupsCollected", gameState.stats.powerupsCollected.toString());
            localStorage.setItem("jumpsUsed", gameState.stats.jumpsUsed.toString());
            localStorage.setItem("achievements", JSON.stringify(gameState.achievements));
        }

        function loadStats() {
            const savedAchievements = localStorage.getItem("achievements");
            if (savedAchievements) {
                try {
                    gameState.achievements = {
                        ...gameState.achievements,
                        ...JSON.parse(savedAchievements),
                    };
                } catch (e) {
                    console.warn("Failed to load achievements from localStorage");
                }
            }
            
            gameState.stats = {
                gamesPlayed: parseInt(localStorage.getItem("gamesPlayed") || "0"),
                totalScore: parseInt(localStorage.getItem("totalScore") || "0"),
                totalDistance: parseInt(localStorage.getItem("totalDistance") || "0"),
                powerupsCollected: parseInt(localStorage.getItem("powerupsCollected") || "0"),
                jumpsUsed: parseInt(localStorage.getItem("jumpsUsed") || "0"),
            };
        }

        // Event Listeners
        function setupEventListeners() {
            document.addEventListener("keydown", (e) => {
                if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", " ", "Space", "KeyP"].includes(e.code)) {
                    e.preventDefault();
                    gameState.keys[e.code] = true;
                    gameState.keys[e.key] = true;
                    
                    // Handle space bar immediately for jump
                    if ((e.code === "Space" || e.key === " ") && gameState.gameRunning && !gameState.gamePaused) {
                        if (gameState.jumpsLeft > 0 && !gameState.player.jumping) {
                            jump();
                        }
                    }
                }
            });

            document.addEventListener("keyup", (e) => {
                gameState.keys[e.code] = false;
                gameState.keys[e.key] = false;
            });

            window.addEventListener("resize", () => {
                gameState.isMobile = window.innerWidth <= 768;
                gameState.updateLanes();
            });

            document.addEventListener("contextmenu", (e) => {
                e.preventDefault();
            });

            let lastTouchEnd = 0;
            document.addEventListener("touchend", (e) => {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        // Add CSS animations for effects
        const style = document.createElement('style');
        style.textContent = `
            @keyframes floatUp {
                0% {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
                100% {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-60px);
                }
            }
            
            @keyframes sparkleOut {
                0% {
                    opacity: 1;
                    transform: scale(1) translate(0, 0);
                }
                100% {
                    opacity: 0;
                    transform: scale(0.5) translate(
                        calc(cos(var(--angle)) * 40px),
                        calc(sin(var(--angle)) * 40px)
                    );
                }
            }
            
            @keyframes debrisFly {
                0% {
                    opacity: 1;
                    transform: scale(1) translate(0, 0);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(0.8) translate(
                        calc(cos(var(--angle)) * 60px),
                        calc(sin(var(--angle)) * 60px)
                    );
                }
                100% {
                    opacity: 0;
                    transform: scale(0.3) translate(
                        calc(cos(var(--angle)) * 120px),
                        calc(sin(var(--angle)) * 120px)
                    );
                }
            }
            
            @keyframes centerPulse {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(2);
                    opacity: 0.8;
                }
                100% {
                    transform: scale(3);
                    opacity: 0;
                }
            }
            
            @keyframes shieldWave {
                0% {
                    opacity: 0;
                    transform: scale(0.5);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.2);
                }
                100% {
                    opacity: 0;
                    transform: scale(2);
                }
            }
            
            @keyframes speedLineMove {
                0% {
                    top: -50px;
                    opacity: 0;
                }
                20% {
                    opacity: 1;
                }
                80% {
                    opacity: 1;
                }
                100% {
                    top: 100%;
                    opacity: 0;
                }
            }
            
            @keyframes jumpBurstUp {
                0% {
                    transform: translateX(calc(-50% + var(--offset))) translateY(0) scale(1);
                    opacity: 1;
                }
                100% {
                    transform: translateX(calc(-50% + var(--offset))) translateY(-100px) scale(0.3);
                    opacity: 0;
                }
            }
            
            @keyframes scoreFloat {
                0% {
                    transform: translate(0, 0) scale(1);
                    opacity: 1;
                }
                100% {
                    transform: translate(var(--random-x), var(--random-y)) scale(0.5);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize Game
        function initGame() {
            gameState.isMobile = window.innerWidth <= 768;
            gameState.updateLanes();
            
            setupTrackSelection();
            setupCarCreator();
            setupMobileControls();
            setupEventListeners();
            
            loadStats();
            updateMenuStats();
            updateAchievementsPreview();
            
            gameState.highScore = parseInt(localStorage.getItem("carGameHighScore") || "0");
            
            showScreen("menu-screen");
        }

        // Start the game when DOM is loaded
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initGame);
        } else {
            initGame();
        }
    </script>
</body>
</html>